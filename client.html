<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Streaming Text-to-Speech Client</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    </head>
    <body>
        <div class="container mx-auto p-4 max-w-2xl">
            <div id="connectionStatus" class="mb-4 p-2 bg-yellow-100 rounded">
                Connecting to server...
            </div>

            <div class="mb-4">
                <label for="voiceSelect" class="block mb-2">Voice:</label>
                <select id="voiceSelect" class="w-full p-2 border rounded">
                    <option value="en-f-1">English Female 1</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="textInput" class="block mb-2">Text to speak:</label>
                <textarea
                    id="textInput"
                    rows="4"
                    class="w-full p-2 border rounded"
                    placeholder="Enter text here..."
                ></textarea>
            </div>

            <button
                id="generateBtn"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                onclick="generateSpeech()"
            >
                Generate Speech
            </button>

            <div id="audioContainer" class="mt-4">
                <audio id="audioPlayer" controls class="w-full"></audio>
            </div>
        </div>

        <script>
            let sessionId = null;
            const socket = io("http://localhost:5050");

            socket.on("connect", () => {
                document.getElementById("connectionStatus").innerHTML =
                    "Connected to server";
                document.getElementById("connectionStatus").className =
                    "mb-4 p-2 bg-green-100 rounded";
                initializeSession();
            });

            socket.on("disconnect", () => {
                document.getElementById("connectionStatus").innerHTML =
                    "Disconnected from server";
                document.getElementById("connectionStatus").className =
                    "mb-4 p-2 bg-red-100 rounded";
            });

            async function initializeSession() {
                try {
                    const response = await fetch(
                        "http://localhost:5050/session/new",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/x-www-form-urlencoded",
                            },
                            body: `voice=${document.getElementById("voiceSelect").value}`,
                        },
                    );

                    const data = await response.json();
                    sessionId = data.session_id;
                    console.log("Session initialized:", sessionId);
                } catch (error) {
                    console.error("Failed to initialize session:", error);
                }
            }

            async function generateSpeech() {
                if (!sessionId) {
                    alert(
                        "Session not initialized. Please wait and try again.",
                    );
                    return;
                }

                const text = document.getElementById("textInput").value;
                if (!text) {
                    alert("Please enter some text");
                    return;
                }

                try {
                    const response = await fetch(
                        "http://localhost:5050/tts_stream",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Accept: "audio/wav",
                            },
                            body: JSON.stringify({
                                text: text,
                                sessionId: sessionId,
                                voice: document.getElementById("voiceSelect")
                                    .value,
                            }),
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const reader = response.body.getReader();
                    const audioContext = new AudioContext();
                    const sourceNode = audioContext.createBufferSource();
                    const audioBuffer = [];

                    async function read() {
                        const { done, value } = await reader.read();
                        if (done) {
                            const combinedBuffer = new Uint8Array(
                                audioBuffer.flat(),
                            );
                            const audioData =
                                await audioContext.decodeAudioData(
                                    combinedBuffer.buffer,
                                );
                            sourceNode.buffer = audioData;
                            sourceNode.connect(audioContext.destination);
                            sourceNode.start();
                            return;
                        }
                        audioBuffer.push(value);
                        read();
                    }

                    read();
                } catch (error) {
                    console.error("Error generating speech:", error);
                    alert(
                        "Failed to generate speech. Check console for details.",
                    );
                }
            }
        </script>
    </body>
</html>
